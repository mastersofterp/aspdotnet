# Always check the powershell script for double quotes

stages:
  - run_script

.deploy_template: &deploy_template
    variables:
        liveBranchName: "main"
        uatBranchName: "UAT"
        developmentBranchName: "Development"
        testBranchName: "Test"
        publishProfilesPath: "$CI_PROJECT_DIR/PresentationLayer/App_Data/PublishProfiles"
        deploymentOutput: ""
        gitCompareCommand: "git diff --name-only origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" # can add --ignore-all-space to ignore all whitespace
    script:
        - powershell -executionpolicy bypass -File "C:\GitLabRunner\CICD-Scripts\powershell-deployment.ps1"
            -projectName "$CI_PROJECT_NAME"
            -branchName "$CI_COMMIT_REF_NAME"
            -projectPath "$CI_PROJECT_DIR"
            -csprojFile "$CI_PROJECT_DIR/RFC_CODE.sln"
            -apiURL "$CI_API_V4_URL" 
            -projectID "$CI_PROJECT_ID" 
            -liveBranchName $liveBranchName 
            -livePublishProfile "$publishProfilesPath/FolderProfile_LIVE_DAIICT.pubxml,$publishProfilesPath/FolderProfile_LIVE_DCH.pubxml,$publishProfilesPath/FolderProfile_LIVE_HITS.pubxml,$publishProfilesPath/FolderProfile_LIVE_IPER.pubxml,$publishProfilesPath/FolderProfile_LIVE_IPR.pubxml,$publishProfilesPath/FolderProfile_LIVE_MAHER.pubxml,$publishProfilesPath/FolderProfile_LIVE_PCEN.pubxml,$publishProfilesPath/FolderProfile_LIVE_PRMCEM.pubxml,$publishProfilesPath/FolderProfile_LIVE_PRMITR.pubxml,$publishProfilesPath/FolderProfile_LIVE_SIMS.pubxml,$publishProfilesPath/FolderProfile_LIVE_CPUH.pubxml,$publishProfilesPath/FolderProfile_LIVE_CPUKOTA.pubxml,$publishProfilesPath/FolderProfile_LIVE_CRESCENT.pubxml,$publishProfilesPath/FolderProfile_LIVE_MITAOE.pubxml,$publishProfilesPath/FolderProfile_LIVE_RCPIPER.pubxml,$publishProfilesPath/FolderProfile_LIVE_RCPIT.pubxml,$publishProfilesPath/FolderProfile_LIVE_JECRC.pubxml,$publishProfilesPath/FolderProfile_LIVE_PJLCE.pubxml,$publishProfilesPath/FolderProfile_LIVE_ADCET.pubxml,$publishProfilesPath/FolderProfile_LIVE_KLSGIT.pubxml,$publishProfilesPath/FolderProfile_LIVE_PU.pubxml,$publishProfilesPath/FolderProfile_LIVE_SJCOE.pubxml,$publishProfilesPath/FolderProfile_LIVE_KIET.pubxml" 
            -liveMachineName "daiict-app,prmitra-app,hits-app,prmitra-app,prmitra-app,rfcccshared-app,rfcccshared-app,prmitra-app,prmitra-app,MSERPDEMOSERVER,cpu-app,cpu-app,crescent-app,mitaoe-app,RCPITAPPSERVER,RCPITAPPSERVER,jecrc-app,rfcccshared-app,rfcccshared-app,klsgit-app,pu-app,sjcoe-app,kiet-app"
            -uatBranchName $uatBranchName 
            -uatPublishProfile "$publishProfilesPath/FolderProfile_UAT_DAIICT.pubxml,$publishProfilesPath/FolderProfile_UAT_DCH.pubxml,$publishProfilesPath/FolderProfile_UAT_HITS.pubxml,$publishProfilesPath/FolderProfile_UAT_IPER.pubxml,$publishProfilesPath/FolderProfile_UAT_IPR.pubxml,$publishProfilesPath/FolderProfile_UAT_MAHER.pubxml,$publishProfilesPath/FolderProfile_UAT_PCEN.pubxml,$publishProfilesPath/FolderProfile_UAT_PRMCEM.pubxml,$publishProfilesPath/FolderProfile_UAT_PRMITR.pubxml,$publishProfilesPath/FolderProfile_UAT_RCPIT.pubxml,$publishProfilesPath/FolderProfile_UAT_RCPIPER.pubxml,$publishProfilesPath/FolderProfile_UAT_CRESCENT.pubxml,$publishProfilesPath/FolderProfile_UAT_JECRC.pubxml,$publishProfilesPath/FolderProfile_UAT_CPUKOTA.pubxml,$publishProfilesPath/FolderProfile_UAT_CPUH.pubxml,$publishProfilesPath/FolderProfile_UAT_MITAOE.pubxml,$publishProfilesPath/FolderProfile_UAT_RFCDEV.pubxml,$publishProfilesPath/FolderProfile_UAT_PJLCE.pubxml,$publishProfilesPath/FolderProfile_UAT_ADCET.pubxml,$publishProfilesPath/FolderProfile_UAT_TGPCET.pubxml,$publishProfilesPath/FolderProfile_UAT_CUCHD.pubxml,$publishProfilesPath/FolderProfile_UAT_KLSGIT.pubxml,$publishProfilesPath/FolderProfile_UAT_PU.pubxml,$publishProfilesPath/FolderProfile_UAT_SJCOE.pubxml,$publishProfilesPath/FolderProfile_UAT_KIET.pubxml"
            -uatMachineName "daiict-app,RFC-DEVAPP,hits-app,RFC-DEVAPP,RFC-DEVAPP,rfcccshared-app,rfcccshared-app,RFC-DEVAPP,RFC-DEVAPP,RFC-DEVAPP,RFC-DEVAPP,crescent-app,RFC-DEVAPP,RFC-DEVAPP,RFC-DEVAPP,RFC-DEVAPP,RFC-DEVAPP,RFC-DEVAPP,rfcccshared-app,rfcccshared-app,cuchd-app,klsgit-app,pu-app,sjcoe-app,kiet-app"
            -developmentBranchName $developmentBranchName 
            -devPublishProfile "$publishProfilesPath/FolderProfile_DEV_RFCDEV.pubxml"
            -devMachineName "RFC-DEVAPP" 
            -testBranchName $testBranchName
            -testPublishProfile "$publishProfilesPath/FolderProfile_TEST_RFCTEST.pubxml,$publishProfilesPath/FolderProfile_TEST_RFCAUTOMATIONTEST.pubxml"
            -testMachineName "RFC-DEVAPP,RFC-DEVAPP"
            -restorePreviousWebConfig "true" 
            -minutesForDeployment 50
            -applicationType "ASP"
            -aspCSPROJFile "$CI_PROJECT_DIR/BusinessLogicLayer/BusinessLogicLayer.csproj,$CI_PROJECT_DIR/HostelBusinessLogicLayer/HostelBusinessLogicLayer.csproj,$CI_PROJECT_DIR/NonAcadBusinessLogicLayer/NonAcadBusinessLogicLayer.csproj"
            -aspDLLCopyToFilePath "$CI_PROJECT_DIR/PresentationLayer/Bin"
            -restoreFromBackupFiles "/image" 
            -deleteAfterPublishFiles "/APP_CODE,/website.publishproj" 
            -publishPrecompilePath "$CI_PROJECT_DIR\PrecompiledWeb\PresentationLayer\"   
            -restoreDefaultFile "true"
        
    rules:
        - if: '$CI_COMMIT_MESSAGE =~ /See merge request/'


# job_SidDesktop: # for test purposes only
#     stage: run_script
#     tags: 
#         - SidDesktop    
#     <<: *deploy_template    

job_RFC-DEVAPP:
  stage: run_script
  tags: 
    - RFC-DEVAPP
  <<: *deploy_template

job_simsdemo-app:
  stage: run_script
  tags: 
    - simsdemo-app
  <<: *deploy_template

job_hits-app:
  stage: run_script
  tags: 
    - hits-app
  <<: *deploy_template

job_daiict-app:
  stage: run_script
  tags: 
    - daiict-app
  <<: *deploy_template

job_mserp-app-rfc-shared:
  stage: run_script
  tags: 
    - mserp-app-rfc-shared
  <<: *deploy_template

job_prmitra-app:
  stage: run_script
  tags: 
    - prmitra-app
  <<: *deploy_template


job_RCPITAPPSERVER:
  stage: run_script
  tags: 
    - RCPITAPPSERVER
  <<: *deploy_template

job_cpu-app:
  stage: run_script
  tags: 
    - cpu-app
  <<: *deploy_template

job_crescent-app:
  stage: run_script
  tags: 
    - crescent-app
  <<: *deploy_template

job_mitaoe-app:
  stage: run_script
  tags: 
    - mitaoe-app
  <<: *deploy_template

job_jecrc-app:
  stage: run_script
  tags: 
    - jecrc-app
  <<: *deploy_template

job_rfcccshared-app:
  stage: run_script
  tags: 
    - rfcccshared-app
  <<: *deploy_template


job_cuchd-app:
  stage: run_script
  tags: 
    - cuchd-app
  <<: *deploy_template

job_klsgit-app:
  stage: run_script
  tags: 
    - klsgit-app
  <<: *deploy_template

job_pu-app:
  stage: run_script
  tags: 
    - pu-app
  <<: *deploy_template

job_sjcoe-app:
  stage: run_script
  tags: 
    - sjcoe-app
  <<: *deploy_template

job_kiet-app:
  stage: run_script
  tags: 
    - kiet-app
  <<: *deploy_template

